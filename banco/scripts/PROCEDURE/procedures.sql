
CREATE PROCEDURE DBO.USP_TB_LANCHE
AS
	SELECT * FROM TB_LANCHE
RETURN
GO

CREATE PROCEDURE DBO.USP_TB_INGREDIENTE
AS
	SELECT * FROM TB_INGREDIENTE
RETURN
GO

CREATE PROCEDURE DBO.USP_TB_VENDAS
AS
	SELECT * FROM TB_VENDAS
RETURN
GO

CREATE PROCEDURE DBO.USP_TB_VENDAS_LANCHES
AS
	SELECT * FROM TB_VENDAS_LANCHES
RETURN
GO

CREATE PROCEDURE DBO.USP_TB_DOMINIO
AS
	SELECT * FROM TB_DOMINIO
RETURN
GO


CREATE PROCEDURE DBO.USP_TB_LANCHE_INGREDIENTE
AS
	SELECT * FROM TB_LANCHE_INGREDIENTE
RETURN
GO

CREATE PROCEDURE DBO.USP_CARREGAR_VENDAS_LANCHE
AS
	
		SELECT 
			TVL.COD_VENDAS AS CODIGO,
			TL.COD_LANCHE,
			TL.LANCHE,
			TD.DOMINIO AS [TIPO_LANCHE],
			STUFF((
				SELECT ',' + INGREDIENTE
					FROM TB_INGREDIENTE
				FOR XML PATH('')
				), 1, 1, '') AS INGREDIENTE,
			SUM(TI.VALOR) AS VALOR
	
		FROM TB_LANCHE TL 
			INNER JOIN TB_LANCHE_INGREDIENTE TLI
				ON TL.COD_LANCHE = TLI.COD_LANCHE
			INNER JOIN TB_INGREDIENTE TI
				ON TI.COD_INGREDIENTE = TLI.COD_INGREDIENTE
			INNER JOIN TB_VENDAS_LANCHES TVL
				ON TVL.COD_LANCHE = TL.COD_LANCHE
			INNER JOIN TB_DOMINIO TD
				ON TVL.COD_DOMINO = TD.COD_DOMINO
		GROUP BY TVL.COD_VENDAS,
				 TL.COD_LANCHE,
				 TL.LANCHE,
				 TD.DOMINIO

RETURN 
GO

CREATE PROCEDURE dbo.USP_DELETA_VENDAS_LANCHES
(
	@codigo int
)
AS
DELETE
    FROM TB_VENDAS_LANCHES
    WHERE 
    COD_VENDAS = @codigo

DELETE 
	FROM TB_VENDAS
	WHERE 
	COD_VENDAS = @codigo
RETURN
GO

CREATE PROCEDURE dbo.USP_INSERIR_VENDAS_LANCHE
(
	@cod_lanche varchar(1000) ,
	@descricao_venda varchar
)
AS
DECLARE @IDENT INT 
	INSERT INTO TB_VENDAS(DESC_VENDAS) VALUES
	(@descricao_venda)
SET @IDENT = @@IDENTITY

DECLARE @TABLE TABLE(CONT INT IDENTITY, COD_LANCHE INT)
	INSERT INTO @TABLE(COD_LANCHE)
	SELECT NAME FROM dbo.splitstring(@cod_lanche)


DECLARE @CONT INT, @CODLANCHE INT
SET @CONT = 1
WHILE (@CONT <= (SELECT COUNT(*) FROM @TABLE))
	BEGIN
		
		SELECT @CODLANCHE = COD_LANCHE FROM @TABLE WHERE CONT = @CONT

		INSERT INTO TB_VENDAS_LANCHES(COD_LANCHE, COD_DOMINO, COD_VENDAS)
			 VALUES (@CODLANCHE, null, @IDENT)

	    SET @CONT = @CONT + 1
	END
RETURN
GO
